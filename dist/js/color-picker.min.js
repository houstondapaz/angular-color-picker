angular.module("angularColorPicker",[]).directive("colorPicker",function(){return{restrict:"E",scope:{topic:"=",mode:"=",color:"="},link:function($scope,$element){$element.addClass("ui-color-picker");var element=$element[0],options={topic:$scope.topic,mode:$scope.mode},picker=new UIColorPicker.init(element,options);$scope.color&&picker.setColor($scope.color),UIColorPicker.subscribe($scope.topic,function(value){$scope.color=value,$scope.$apply()})}}});
"use strict";var UIColorPicker=function(){function Color(color){if(color instanceof Color==!0)return void this.copy(color);this.r=0,this.g=0,this.b=0,this.a=1,this.hue=0,this.saturation=0,this.value=0,this.lightness=0,this.format="HSV"}function RGBColor(r,g,b){var color=new Color;return color.setRGBA(r,g,b,1),color}function RGBAColor(r,g,b,a){var color=new Color;return color.setRGBA(r,g,b,a),color}function HSVColor(h,s,v){var color=new Color;return color.setHSV(h,s,v),color}function HSVAColor(h,s,v,a){var color=new Color;return color.setHSV(h,s,v),color.a=a,color}function HSLColor(h,s,l){var color=new Color;return color.setHSL(h,s,l),color}function HSLAColor(h,s,l,a){var color=new Color;return color.setHSL(h,s,l),color.a=a,color}function getRelativeCoordinates(container,e){var ref,pos={},offset={};for(ref=container.offsetParent,pos.x=e.touches?e.touches[0].pageX:e.pageX,pos.y=e.touches?e.touches[0].pageY:e.pageY,offset.left=container.offsetLeft,offset.top=container.offsetTop;ref;)offset.left+=ref.offsetLeft,offset.top+=ref.offsetTop,ref=ref.offsetParent;return{x:pos.x-offset.left,y:pos.y-offset.top}}function ColorPicker(node,options){this.color=new Color,this.node=node,this.subscribers=[];var type=options.mode,topic=options.topic;this.topic=topic,this.picker_mode="HSL"===type?"HSL":"HSV",this.color.setFormat(this.picker_mode),this.createPickingArea(),this.createHueArea(),this.newInputComponent("H","hue",this.inputChangeHue.bind(this)),this.newInputComponent("S","saturation",this.inputChangeSaturation.bind(this)),this.newInputComponent("V","value",this.inputChangeValue.bind(this)),this.newInputComponent("L","lightness",this.inputChangeLightness.bind(this)),this.createAlphaArea(),this.newInputComponent("R","red",this.inputChangeRed.bind(this)),this.newInputComponent("G","green",this.inputChangeGreen.bind(this)),this.newInputComponent("B","blue",this.inputChangeBlue.bind(this)),this.createPreviewBox(),this.createChangeModeButton(),this.newInputComponent("alpha","alpha",this.inputChangeAlpha.bind(this)),this.newInputComponent("hexa","hexa",this.inputChangeHexa.bind(this)),this.setColor(this.color),pickers[topic]=this}var subscribers=[],pickers=[];Color.prototype.copy=function(obj){if(obj instanceof Color!=!0)return void console.log("Typeof parameter not Color");this.r=obj.r,this.g=obj.g,this.b=obj.b,this.a=obj.a,this.hue=obj.hue,this.saturation=obj.saturation,this.value=obj.value,this.format=""+obj.format,this.lightness=obj.lightness},Color.prototype.setFormat=function(format){"HSV"===format&&(this.format="HSV"),"HSL"===format&&(this.format="HSL")},Color.prototype.isValidRGBValue=function(value){return"number"==typeof value&&isNaN(value)===!1&&value>=0&&value<=255},Color.prototype.setRGBA=function(red,green,blue,alpha){this.isValidRGBValue(red)!==!1&&this.isValidRGBValue(green)!==!1&&this.isValidRGBValue(blue)!==!1&&(this.r=0|red,this.g=0|green,this.b=0|blue,this.isValidRGBValue(alpha)===!0&&(this.a=0|alpha))},Color.prototype.setByName=function(name,value){if("r"===name||"g"===name||"b"===name){if(this.isValidRGBValue(value)===!1)return;this[name]=value,this.updateHSX()}},Color.prototype.setHSV=function(hue,saturation,value){this.hue=hue,this.saturation=saturation,this.value=value,this.HSVtoRGB()},Color.prototype.setHSL=function(hue,saturation,lightness){this.hue=hue,this.saturation=saturation,this.lightness=lightness,this.HSLtoRGB()},Color.prototype.setHue=function(value){"number"!=typeof value||isNaN(value)===!0||value<0||value>359||(this.hue=value,this.updateRGB())},Color.prototype.setSaturation=function(value){"number"!=typeof value||isNaN(value)===!0||value<0||value>100||(this.saturation=value,this.updateRGB())},Color.prototype.setValue=function(value){"number"!=typeof value||isNaN(value)===!0||value<0||value>100||(this.value=value,this.HSVtoRGB())},Color.prototype.setLightness=function(value){"number"!=typeof value||isNaN(value)===!0||value<0||value>100||(this.lightness=value,this.HSLtoRGB())},Color.prototype.setHexa=function(value){/(^#{0,1}[0-9A-F]{6}$)|(^#{0,1}[0-9A-F]{3}$)/i.test(value)===!0&&("#"===value[0]&&(value=value.slice(1,value.length)),3===value.length&&(value=value.replace(/([0-9A-F])([0-9A-F])([0-9A-F])/i,"$1$1$2$2$3$3")),this.r=parseInt(value.substr(0,2),16),this.g=parseInt(value.substr(2,2),16),this.b=parseInt(value.substr(4,2),16),this.alpha=1,this.RGBtoHSV())},Color.prototype.convertToHSL=function(){"HSL"!==this.format&&(this.setFormat("HSL"),this.RGBtoHSL())},Color.prototype.convertToHSV=function(){"HSV"!==this.format&&(this.setFormat("HSV"),this.RGBtoHSV())},Color.prototype.updateRGB=function(){return"HSV"===this.format?void this.HSVtoRGB():"HSL"===this.format?void this.HSLtoRGB():void 0},Color.prototype.updateHSX=function(){return"HSV"===this.format?void this.RGBtoHSV():"HSL"===this.format?void this.RGBtoHSL():void 0},Color.prototype.HSVtoRGB=function(){var sat=this.saturation/100,value=this.value/100,C=sat*value,H=this.hue/60,X=C*(1-Math.abs(H%2-1)),m=value-C;return C=255*(C+m)|0,X=255*(X+m)|0,m=255*m|0,H>=0&&H<1?void this.setRGBA(C,X,m):H>=1&&H<2?void this.setRGBA(X,C,m):H>=2&&H<3?void this.setRGBA(m,C,X):H>=3&&H<4?void this.setRGBA(m,X,C):H>=4&&H<5?void this.setRGBA(X,m,C):H>=5&&H<6?void this.setRGBA(C,m,X):void 0},Color.prototype.HSLtoRGB=function(){var sat=this.saturation/100,light=this.lightness/100,C=sat*(1-Math.abs(2*light-1)),H=this.hue/60,X=C*(1-Math.abs(H%2-1)),m=light-C/2;return C=255*(C+m)|0,X=255*(X+m)|0,m=255*m|0,H>=0&&H<1?void this.setRGBA(C,X,m):H>=1&&H<2?void this.setRGBA(X,C,m):H>=2&&H<3?void this.setRGBA(m,C,X):H>=3&&H<4?void this.setRGBA(m,X,C):H>=4&&H<5?void this.setRGBA(X,m,C):H>=5&&H<6?void this.setRGBA(C,m,X):void 0},Color.prototype.RGBtoHSV=function(){var red=this.r/255,green=this.g/255,blue=this.b/255,cmax=Math.max(red,green,blue),cmin=Math.min(red,green,blue),delta=cmax-cmin,hue=0,saturation=0;delta&&(cmax===red&&(hue=(green-blue)/delta),cmax===green&&(hue=2+(blue-red)/delta),cmax===blue&&(hue=4+(red-green)/delta),cmax&&(saturation=delta/cmax)),this.hue=60*hue|0,this.hue<0&&(this.hue+=360),this.saturation=100*saturation|0,this.value=100*cmax|0},Color.prototype.RGBtoHSL=function(){var red=this.r/255,green=this.g/255,blue=this.b/255,cmax=Math.max(red,green,blue),cmin=Math.min(red,green,blue),delta=cmax-cmin,hue=0,saturation=0,lightness=(cmax+cmin)/2,X=1-Math.abs(2*lightness-1);delta&&(cmax===red&&(hue=(green-blue)/delta),cmax===green&&(hue=2+(blue-red)/delta),cmax===blue&&(hue=4+(red-green)/delta),cmax&&(saturation=delta/X)),this.hue=60*hue|0,this.hue<0&&(this.hue+=360),this.saturation=100*saturation|0,this.lightness=100*lightness|0},Color.prototype.getHexa=function(){var r=this.r.toString(16),g=this.g.toString(16),b=this.b.toString(16);return this.r<16&&(r="0"+r),this.g<16&&(g="0"+g),this.b<16&&(b="0"+b),("#"+r+g+b).toUpperCase()},Color.prototype.getRGBA=function(){var rgb="("+this.r+", "+this.g+", "+this.b,a="",v="",x=parseFloat(this.a);return 1!==x&&(a="a",v=", "+x),"rgb"+a+rgb+v+")"},Color.prototype.getHSLA=function(){if("HSV"===this.format){var color=new Color(this);return color.setFormat("HSL"),color.updateHSX(),color.getHSLA()}var a="",v="",hsl="("+this.hue+", "+this.saturation+"%, "+this.lightness+"%",x=parseFloat(this.a);return 1!==x&&(a="a",v=", "+x),"hsl"+a+hsl+v+")"},Color.prototype.getColor=function(){return 0|this.a?this.getHexa():this.getRGBA()};var setMouseTracking=function(elem,callback){elem.addEventListener("mousedown",function(e){callback(e),document.addEventListener("mousemove",callback)}),document.addEventListener("mouseup",function(e){document.removeEventListener("mousemove",callback)})};ColorPicker.prototype.createPickingArea=function(){var area=document.createElement("div"),picker=document.createElement("div");area.className="picking-area",picker.className="picker",this.picking_area=area,this.color_picker=picker,setMouseTracking(area,this.updateColor.bind(this)),area.appendChild(picker),this.node.appendChild(area)},ColorPicker.prototype.createHueArea=function(){var area=document.createElement("div"),picker=document.createElement("div");area.className="hue",picker.className="slider-picker",this.hue_area=area,this.hue_picker=picker,setMouseTracking(area,this.updateHueSlider.bind(this)),area.appendChild(picker),this.node.appendChild(area)},ColorPicker.prototype.createAlphaArea=function(){var area=document.createElement("div"),mask=document.createElement("div"),picker=document.createElement("div");area.className="alpha",mask.className="alpha-mask",picker.className="slider-picker",this.alpha_area=area,this.alpha_mask=mask,this.alpha_picker=picker,setMouseTracking(area,this.updateAlphaSlider.bind(this)),area.appendChild(mask),mask.appendChild(picker),this.node.appendChild(area)},ColorPicker.prototype.createPreviewBox=function(e){var preview_box=document.createElement("div"),preview_color=document.createElement("div");preview_box.className="preview",preview_color.className="preview-color",this.preview_color=preview_color,preview_box.appendChild(preview_color),this.node.appendChild(preview_box)},ColorPicker.prototype.newInputComponent=function(title,topic,onChangeFunc){var wrapper=document.createElement("div"),input=document.createElement("input"),info=document.createElement("span");wrapper.className="input",wrapper.setAttribute("data-topic",topic),info.textContent=title,info.className="name",input.setAttribute("type","text"),wrapper.appendChild(info),wrapper.appendChild(input),this.node.appendChild(wrapper),input.addEventListener("change",onChangeFunc),input.addEventListener("click",function(){this.select()}),this.subscribe(topic,function(value){input.value=value})},ColorPicker.prototype.createChangeModeButton=function(){var button=document.createElement("div");button.className="switch_mode",button.addEventListener("click",function(){"HSV"===this.picker_mode?this.setPickerMode("HSL"):this.setPickerMode("HSV")}.bind(this)),this.node.appendChild(button)},ColorPicker.prototype.updateColor=function(e){var pos=getRelativeCoordinates(this.picking_area,e),x=pos.x,y=pos.y,size=this.picking_area.clientWidth;x>size&&(x=size),y>size&&(y=size),x<0&&(x=0),y<0&&(y=0);var value=100-100*y/size|0,saturation=100*x/size|0;"HSV"===this.picker_mode&&this.color.setHSV(this.color.hue,saturation,value),"HSL"===this.picker_mode&&this.color.setHSL(this.color.hue,saturation,value),this.color_picker.style.left=x-5+"px",this.color_picker.style.top=y-5+"px",this.updateAlphaGradient(),this.updatePreviewColor(),this.notify("value",value),this.notify("lightness",value),this.notify("saturation",saturation),this.notify("red",this.color.r),this.notify("green",this.color.g),this.notify("blue",this.color.b),this.notify("hexa",this.color.getHexa()),notify(this.topic,this.color)},ColorPicker.prototype.updateHueSlider=function(e){var x=getRelativeCoordinates(this.hue_area,e).x,width=this.hue_area.clientWidth;x<0&&(x=0),x>width&&(x=width);var hue=359*x/width|0;this.updateSliderPosition(this.hue_picker,x),this.setHue(hue)},ColorPicker.prototype.updateAlphaSlider=function(e){var x=getRelativeCoordinates(this.alpha_area,e).x,width=this.alpha_area.clientWidth;x<0&&(x=0),x>width&&(x=width),this.color.a=(x/width).toFixed(2),this.updateSliderPosition(this.alpha_picker,x),this.updatePreviewColor(),this.notify("alpha",this.color.a),notify(this.topic,this.color)},ColorPicker.prototype.setHue=function(value){this.color.setHue(value),this.updatePickerBackground(),this.updateAlphaGradient(),this.updatePreviewColor(),this.notify("red",this.color.r),this.notify("green",this.color.g),this.notify("blue",this.color.b),this.notify("hexa",this.color.getHexa()),this.notify("hue",this.color.hue),notify(this.topic,this.color)},ColorPicker.prototype.updateSLV=function(){this.updatePickerPosition(),this.updateAlphaGradient(),this.updatePreviewColor(),this.notify("red",this.color.r),this.notify("green",this.color.g),this.notify("blue",this.color.b),this.notify("hexa",this.color.getHexa()),notify(this.topic,this.color)},ColorPicker.prototype.updatePickerPosition=function(){var size=this.picking_area.clientWidth,value=0;"HSV"===this.picker_mode&&(value=this.color.value),"HSL"===this.picker_mode&&(value=this.color.lightness);var x=this.color.saturation*size/100|0,y=size-value*size/100|0;this.color_picker.style.left=x-5+"px",this.color_picker.style.top=y-5+"px"},ColorPicker.prototype.updateSliderPosition=function(elem,pos){elem.style.left=Math.max(pos-3,-2)+"px"},ColorPicker.prototype.updateHuePicker=function(){var size=this.hue_area.clientWidth,pos=this.color.hue*size/360|0;this.hue_picker.style.left=pos-1+"px"},ColorPicker.prototype.updateAlphaPicker=function(){var size=this.alpha_area.clientWidth,pos=this.color.a*size|0;this.alpha_picker.style.left=pos-1+"px"},ColorPicker.prototype.updatePickerBackground=function(){var nc=new Color(this.color);nc.setHSV(nc.hue,100,100),this.picking_area.style.backgroundColor=nc.getHexa()},ColorPicker.prototype.updateAlphaGradient=function(){this.alpha_mask.style.backgroundColor=this.color.getHexa()},ColorPicker.prototype.updatePreviewColor=function(){this.preview_color.style.backgroundColor=this.color.getColor()},ColorPicker.prototype.inputChangeHue=function(e){var value=parseInt(e.target.value);this.setHue(value),this.updateHuePicker()},ColorPicker.prototype.inputChangeSaturation=function(e){var value=parseInt(e.target.value);this.color.setSaturation(value),e.target.value=this.color.saturation,this.updateSLV()},ColorPicker.prototype.inputChangeValue=function(e){var value=parseInt(e.target.value);this.color.setValue(value),e.target.value=this.color.value,this.updateSLV()},ColorPicker.prototype.inputChangeLightness=function(e){var value=parseInt(e.target.value);this.color.setLightness(value),e.target.value=this.color.lightness,this.updateSLV()},ColorPicker.prototype.inputChangeRed=function(e){var value=parseInt(e.target.value);this.color.setByName("r",value),e.target.value=this.color.r,this.setColor(this.color)},ColorPicker.prototype.inputChangeGreen=function(e){var value=parseInt(e.target.value);this.color.setByName("g",value),e.target.value=this.color.g,this.setColor(this.color)},ColorPicker.prototype.inputChangeBlue=function(e){var value=parseInt(e.target.value);this.color.setByName("b",value),e.target.value=this.color.b,this.setColor(this.color)},ColorPicker.prototype.inputChangeAlpha=function(e){var value=parseFloat(e.target.value);"number"==typeof value&&isNaN(value)===!1&&value>=0&&value<=1&&(this.color.a=value.toFixed(2)),e.target.value=this.color.a,this.updateAlphaPicker()},ColorPicker.prototype.inputChangeHexa=function(e){var value=e.target.value;this.color.setHexa(value),this.setColor(this.color)},ColorPicker.prototype.subscribe=function(topic,callback){this.subscribers[topic]=callback},ColorPicker.prototype.notify=function(topic,value){this.subscribers[topic]&&this.subscribers[topic](value)},ColorPicker.prototype.setColor=function(color){if(color instanceof Color!=!0)return void console.log("Typeof parameter not Color");color.format!==this.picker_mode&&(color.setFormat(this.picker_mode),color.updateHSX()),this.color.copy(color),this.updateHuePicker(),this.updatePickerPosition(),this.updatePickerBackground(),this.updateAlphaPicker(),this.updateAlphaGradient(),this.updatePreviewColor(),this.notify("red",this.color.r),this.notify("green",this.color.g),this.notify("blue",this.color.b),this.notify("hue",this.color.hue),this.notify("saturation",this.color.saturation),this.notify("value",this.color.value),this.notify("lightness",this.color.lightness),this.notify("alpha",this.color.a),this.notify("hexa",this.color.getHexa()),notify(this.topic,this.color)},ColorPicker.prototype.setPickerMode=function(mode){"HSV"!==mode&&"HSL"!==mode||(this.picker_mode=mode,this.setColor(this.color))};var setPickerMode=function(topic,mode){pickers[topic]&&pickers[topic].setPickerMode(mode)},setColor=function(topic,color){pickers[topic]&&pickers[topic].setColor(color)},getColor=function(topic){if(pickers[topic])return new Color(pickers[topic].color)},subscribe=function(topic,callback){void 0===subscribers[topic]&&(subscribers[topic]=[]),subscribers[topic].push(callback)},unsubscribe=function(callback){subscribers.indexOf(callback),subscribers.splice(index,1)},notify=function(topic,value){if(void 0!==subscribers[topic]&&0!==subscribers[topic].length){var color=new Color(value);for(var i in subscribers[topic])subscribers[topic][i](color)}};return{init:function(element,options){return new ColorPicker(element,options)},Color:Color,RGBColor:RGBColor,RGBAColor:RGBAColor,HSVColor:HSVColor,HSVAColor:HSVAColor,HSLColor:HSLColor,HSLAColor:HSLAColor,setColor:setColor,getColor:getColor,subscribe:subscribe,unsubscribe:unsubscribe,setPickerMode:setPickerMode}}();